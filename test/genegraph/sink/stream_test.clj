(ns genegraph.sink.stream-test
  (:require [clojure.test :refer :all]
            [genegraph.sink.stream :refer :all]
            [genegraph.database.util :refer [with-test-database]]
            [genegraph.database.query :as q])
  (:import [org.apache.kafka.clients.consumer ConsumerRecord]))

(def dosage-record
  (ConsumerRecord. "gene_dosage_beta"
                   0
                   20148
                   1567164792255
                   org.apache.kafka.common.record.TimestampType/CREATE_TIME
                   3047257890
                   -1
                   4429
                   nil
                   "{\n  \"@context\" : {\n    \"id\" : \"@id\",\n    \"type\" : \"@type\",\n    \"SEPIO\" : \"http://purl.obolibrary.org/obo/SEPIO_\",\n    \"PMID\" : \"https://www.ncbi.nlm.nih.gov/pubmed/\",\n    \"BFO\" : \"http://purl.obolibrary.org/obo/BFO_\",\n    \"CG\" : \"http://dataexchange.clinicalgenome.org/terms/\",\n    \"DC\" : \"http://purl.org/dc/elements/1.1/\",\n    \"OMIM\" : \"http://purl.obolibrary.org/obo/OMIM_\",\n    \"MONDO\" : \"http://purl.obolibrary.org/obo/MONDO_\",\n    \"FALDO\" : \"http://biohackathon.org/resource/faldo#\",\n    \"NCBI_NU\" : \"https://www.ncbi.nlm.nih.gov/nuccore/\",\n    \"RDFS\" : \"http://www.w3.org/2000/01/rdf-schema#\",\n    \"GENO\" : \"http://purl.obolibrary.org/obo/GENO_\",\n    \"IAO\" : \"http://purl.obolibrary.org/obo/IAO_\",\n    \"DCT\" : \"http://purl.org/dc/terms/\",\n    \"has_evidence_with_item\" : {\n      \"@id\" : \"SEPIO:0000189\",\n      \"@type\" : \"@id\"\n    },\n    \"has_predicate\" : {\n      \"@id\" : \"SEPIO:0000389\",\n      \"@type\" : \"@id\"\n    },\n    \"has_subject\" : {\n      \"@id\" : \"SEPIO:0000388\",\n      \"@type\" : \"@id\"\n    },\n    \"has_object\" : {\n      \"@id\" : \"SEPIO:0000390\",\n      \"@type\" : \"@id\"\n    },\n    \"qualified_contribution\" : {\n      \"@id\" : \"SEPIO:0000159\",\n      \"@type\" : \"@id\"\n    },\n    \"is_specified_by\" : {\n      \"@id\" : \"SEPIO:0000041\",\n      \"@type\" : \"@id\"\n    },\n    \"reference\" : {\n      \"@id\" : \"FALDO:reference\",\n      \"@type\" : \"@id\"\n    },\n    \"realizes\" : {\n      \"@id\" : \"BFO:0000055\",\n      \"@type\" : \"@id\"\n    },\n    \"source\" : {\n      \"@id\" : \"DCT:source\",\n      \"@type\" : \"@id\"\n    },\n    \"is_feature_affected_by\" : {\n      \"@id\" : \"GENO:0000445\",\n      \"@type\" : \"@id\"\n    },\n    \"label\" : \"RDFS:label\",\n    \"activity_date\" : \"SEPIO:0000160\",\n    \"has_count\" : \"GENO:0000917\",\n    \"start_position\" : \"GENO:0000894\",\n    \"end_position\" : \"GENO:0000895\",\n    \"description\" : \"DC:description\"\n  },\n  \"description\" : \"Only one paper so far describes a cohort with multiple unrelated individuals with sequence and copy number variants in NBEA, implicating this gene in a neurodevelopment disorder featuring autism, epilepsy, and other related features. \\r\\nAdditional articles :  Allen et al. (PMID 23934111) describes a de novo mutation in Patient IN with epileptic encephalopathy and a variant that results in a stop-gain  (Cohort included 264 patients with infantile spasm\\r\\n and Lennox-Gastaut syndrome).\\r\\n\\r\\nIossifov et al. (PMID 25363768) reported a de novo nonsense variant in a patient with autism spectrum disorder (Patient 13761).\",\n  \"has_predicate\" : \"SEPIO:0000146\",\n  \"has_object\" : \"SEPIO:0002006\",\n  \"type\" : \"SEPIO:0002001\",\n  \"is_specified_by\" : \"SEPIO:0002004\",\n  \"has_evidence_with_item\" : [ {\n    \"type\" : \"SEPIO:0000173\",\n    \"source\" : \"PMID:30269351\",\n    \"description\" : \"Mulhern et al. describe 24 cases with variants of the NBEA gene . Variants include 8 nonsense, 5 frameshift, 4 missense, 5 intragenic deletions , 1 splice site and 1 multigene.   Al variants were absent from gnomad and 12,325 controls. Twenty three of the 24 cases had parental follow-up and were de novo. Twenty of 24 of the variants are predicted to result in Loss of function. All patients had neurodevelopmental disease that included developmental delay and or intellectual disability. Half the patients had autism or autistic features and about half the patients had epilepsy. \\r\\n\\r\\nDrosophila and mouse models demonstrate abnormal synaptic growth and impaired physical and social behavior (PMID 26100104, 23153818).\"\n  }, {\n    \"type\" : \"SEPIO:0000173\",\n    \"source\" : \"PMID:12746398\",\n    \"description\" : \"This paper describes a de novo translocation t(5;13)(q12.1;q13.2) disrupting NBEA in a male with isolated autism.  The breakpoint on 13q falls within the second intron of the NBEA gene. No alternative transcripts lacking the first two exons were identified. The authors predicted that the translocation leads to a lack of NBEA expression\\r\\n\\r\\n\"\n  } ],\n  \"id\" : \"http://dx.clinicalgenome.org/entities/ISCA-11840x1-2019-06-26T16:59:20Z\",\n  \"qualified_contribution\" : {\n    \"activity_date\" : \"2019-06-26T16:59:20Z\",\n    \"realizes\" : \"SEPIO:0000331\"\n  },\n  \"has_subject\" : {\n    \"id\" : \"http://dx.clinicalgenome.org/entities/ISCA-11840x1\",\n    \"has_subject\" : {\n      \"is_feature_affected_by\" : \"https://www.ncbi.nlm.nih.gov/gene/26960\",\n      \"type\" : \"GENO:0000963\",\n      \"has_count\" : 1\n    },\n    \"has_predicate\" : \"GENO:0000840\",\n    \"type\" : \"SEPIO:0002003\",\n    \"has_object\" : \"MONDO:0000001\"\n  }\n}"))


(deftest stream-messages-test
  (with-test-database
    (import-record! dosage-record)
    (is (= 1 (count (q/select "select ?x where { ?x a :sepio/EvidenceLevelAssertion }"))))))
