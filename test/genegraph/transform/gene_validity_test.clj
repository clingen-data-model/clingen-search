(ns genegraph.transform.gene-validity-test
  (:require [clojure.test :refer :all]
            [genegraph.sink.stream :refer :all]
            [genegraph.database.util :refer [with-test-database]]
            [genegraph.database.query :as q])
  (:import [org.apache.kafka.clients.consumer ConsumerRecord]))

(def gene-validity-record
  (ConsumerRecord. "gene_validity"
                   0
                   20148
                   1567164792255
                   org.apache.kafka.common.record.TimestampType/CREATE_TIME
                   3047257890
                   -1
                   4429
                   nil
"{\n    \"iri\": \"007697a5-2f83-40d0-b2ea-914e458a1452\",\n    \"statusPublishFlag\": \"Publish\",\n    \"affiliation\": {\n        \"name\": \"Hearing Loss EP\",\n        \"id\": \"10007\"\n    },\n    \"genes\": [\n        {\n            \"ontology\": \"HGNC\",\n            \"curie\": \"HGNC:23212\",\n            \"uri\": \"HGNC23212\",\n            \"symbol\": \"MYH14\"\n        }\n    ],\n    \"type\": \"clinicalValidity\",\n    \"sopVersion\": \"6\",\n    \"statusFlag\": \"Approved\",\n    \"title\": \"MYH14 : nonsyndromic genetic deafness\",\n    \"curationVersion\": \"TO BE DETERMINED\",\n    \"scoreJson\": {\n        \"ValidContradictoryEvidence\": {\n            \"Value\": \"NO\"\n        },\n        \"summary\": {\n            \"FinalClassificationDate\": \"2018-06-19T04:00:00.000Z\",\n            \"CuratorModifyCalculation\": \"NO\",\n            \"CuratorClassificationDate\": \"2018-12-06T18:33:00.938Z\",\n            \"CalculatedClassificationDate\": \"2018-12-06T18:33:00.938Z\",\n            \"ProvisionalClassificationDate\": \"2017-11-10T05:00:00.000Z\",\n            \"EvidencePointsTotal\": 11.05,\n            \"CuratorClassification\": \"No Modification\",\n            \"CalculatedClassification\": \"Definitive\",\n            \"FinalClassification\": \"Definitive\",\n            \"ProvisionalClassification\": \"No Modification\",\n            \"FinalClassificationNotes\": \"The relationship between MYH14 and autosomal dominant nonsyndromic genetic deafness was evaluated using the ClinGen Clinical Validity Framework as of 11/10/2017. Variants in MYH14 were first reported in humans with this disease as early as 2004 (Donaudy et al., PMID 15015131). At least 11 unique variants (missense, nonsense) have been reported in humans. Evidence supporting this gene-disease relationship includes case-level data, case-control data, segregation data, and experimental data. Variants in this gene have been reported in at least 9 probands in 10 publications (PMID: 15015131, 16222661, 27393652, 28221712, 25719458, 25289672). Variants in this gene segregated with disease in 25 additional family members. The mechanism for disease is thought to be that MYH14 plays a beneficial role in the protection of the cochlea after acoustic over-stimulation and that loss of function leads to progressive hearing loss (PMID: 28101381).This gene-disease association is supported by animal models and expression studies. In summary, MYH14 is definitively associated with ADNSHL (PMID: 15015131, 28101381). This has been repeatedly demonstrated in both the research and clinical diagnostic settings, and has been upheld over time. This classification was approved by the ClinGen Hearing Loss Working Group on 6/19/2018. Note: this gene has also been associated with a neuropathy phenotype that includes hearing loss, but that evidence was not included in this curation.\",\n            \"ExperimentalEvidenceTotal\": 2.5,\n            \"GeneticEvidenceTotal\": 8.55\n        },\n        \"ReplicationOverTime\": \"YES\",\n        \"ExperimentalEvidence\": {\n            \"ModelsRescue\": {\n                \"PointsCounted\": 1,\n                \"Count\": 1,\n                \"NonHumanModelOrganism\": {\n                    \"Evidence\": {\n                        \"Publications\": [\n                            {\n                                \"pubdate\": \"2016 Dec 22\",\n                                \"title\": \"Loss of Myh14 Increases Susceptibility to Noise-Induced Hearing Loss in CBA/CaJ Mice.\",\n                                \"source\": \"Neural plasticity\",\n                                \"author\": \"Fu X\",\n                                \"pmid\": \"28101381\"\n                            }\n                        ]\n                    }\n                }\n            },\n            \"Models\": {\n                \"NonHumanModelOrganism\": {\n                    \"Count\": 1,\n                    \"TotalPoints\": 1\n                }\n            },\n            \"TotalExperimentalEvidencePoints\": {\n                \"PointsCounted\": 2.5\n            },\n            \"Function\": {\n                \"PointsCounted\": 1.5,\n                \"Expression\": {\n                    \"Evidence\": {\n                        \"Publications\": [\n                            {\n                                \"pubdate\": \"2004 Apr\",\n                                \"title\": \"Nonmuscle myosin heavy-chain gene MYH14 is expressed in cochlea and mutated in patients affected by autosomal dominant hearing impairment (DFNA4).\",\n                                \"source\": \"American journal of human genetics\",\n                                \"author\": \"Donaudy F\",\n                                \"pmid\": \"15015131\"\n                            },\n                            {\n                                \"pubdate\": \"2016 Dec 22\",\n                                \"title\": \"Loss of Myh14 Increases Susceptibility to Noise-Induced Hearing Loss in CBA/CaJ Mice.\",\n                                \"source\": \"Neural plasticity\",\n                                \"author\": \"Fu X\",\n                                \"pmid\": \"28101381\"\n                            }\n                        ]\n                    },\n                    \"Count\": 2,\n                    \"TotalPoints\": 1.5\n                }\n            }\n        },\n        \"ModeOfInheritance\": \"Autosomal dominant inheritance (HP:0000006)\",\n        \"GeneticEvidence\": {\n            \"CaseLevelData\": {\n                \"SegregationEvidence\": {\n                    \"CandidateSequencingMethod\": {\n                        \"Evidence\": {\n                            \"Publications\": [\n                                {\n                                    \"pubdate\": \"2004 Apr\",\n                                    \"title\": \"Nonmuscle myosin heavy-chain gene MYH14 is expressed in cochlea and mutated in patients affected by autosomal dominant hearing impairment (DFNA4).\",\n                                    \"source\": \"American journal of human genetics\",\n                                    \"author\": \"Donaudy F\",\n                                    \"pmid\": \"15015131\"\n                                },\n                                {\n                                    \"pubdate\": \"2005 Nov 15\",\n                                    \"title\": \"Genetic heterogeneity of deafness phenotypes linked to DFNA4.\",\n                                    \"source\": \"American journal of medical genetics. Part A\",\n                                    \"author\": \"Yang T\",\n                                    \"pmid\": \"16222661\"\n                                },\n                                {\n                                    \"pubdate\": \"2017 Apr\",\n                                    \"title\": \"Discovery of MYH14 as an important and unique deafness gene causing prelingually severe autosomal dominant nonsyndromic hearing loss.\",\n                                    \"source\": \"The journal of gene medicine\",\n                                    \"author\": \"Kim BJ\",\n                                    \"pmid\": \"28221712\"\n                                }\n                            ]\n                        },\n                        \"FamilyCount\": 3,\n                        \"SummedLod\": 5.72\n                    },\n                    \"PointsCounted\": 1.8,\n                    \"TotalPoints\": 6.92,\n                    \"ExomeSequencingMethod\": {\n                        \"Evidence\": {\n                            \"Publications\": [\n                                {\n                                    \"pubdate\": \"2014 Oct 07\",\n                                    \"title\": \"Whole-exome sequencing to decipher the genetic heterogeneity of hearing loss in a Chinese family with deaf by deaf mating.\",\n                                    \"source\": \"PloS one\",\n                                    \"author\": \"Qing J\",\n                                    \"pmid\": \"25289672\"\n                                }\n                            ]\n                        },\n                        \"FamilyCount\": 1,\n                        \"SummedLod\": 1.2\n                    }\n                },\n                \"VariantEvidence\": {\n                    \"AutosomalDominantOrXlinkedDisorder\": {\n                        \"ProbandWithOtherVariantTypeWithSomeEvidenceOfGeneImpact\": {\n                            \"Evidence\": {\n                                \"Publications\": [\n                                    {\n                                        \"pubdate\": \"2004 Apr\",\n                                        \"title\": \"Nonmuscle myosin heavy-chain gene MYH14 is expressed in cochlea and mutated in patients affected by autosomal dominant hearing impairment (DFNA4).\",\n                                        \"source\": \"American journal of human genetics\",\n                                        \"author\": \"Donaudy F\",\n                                        \"pmid\": \"15015131\"\n                                    },\n                                    {\n                                        \"pubdate\": \"2005 Nov 15\",\n                                        \"title\": \"Genetic heterogeneity of deafness phenotypes linked to DFNA4.\",\n                                        \"source\": \"American journal of medical genetics. Part A\",\n                                        \"author\": \"Yang T\",\n                                        \"pmid\": \"16222661\"\n                                    },\n                                    {\n                                        \"pubdate\": \"2016 Oct 10\",\n                                        \"title\": \"Genetic association of MYH genes with hereditary hearing loss in Korea.\",\n                                        \"source\": \"Gene\",\n                                        \"author\": \"Kim SJ\",\n                                        \"pmid\": \"27393652\"\n                                    },\n                                    {\n                                        \"pubdate\": \"2017 Apr\",\n                                        \"title\": \"Discovery of MYH14 as an important and unique deafness gene causing prelingually severe autosomal dominant nonsyndromic hearing loss.\",\n                                        \"source\": \"The journal of gene medicine\",\n                                        \"author\": \"Kim BJ\",\n                                        \"pmid\": \"28221712\"\n                                    }\n                                ]\n                            },\n                            \"PointsCounted\": 2.25,\n                            \"Count\": 5,\n                            \"TotalPoints\": 2.25\n                        },\n                        \"VariantIsDeNovo\": {\n                            \"Evidence\": {\n                                \"Publications\": [\n                                    {\n                                        \"pubdate\": \"2004 Apr\",\n                                        \"title\": \"Nonmuscle myosin heavy-chain gene MYH14 is expressed in cochlea and mutated in patients affected by autosomal dominant hearing impairment (DFNA4).\",\n                                        \"source\": \"American journal of human genetics\",\n                                        \"author\": \"Donaudy F\",\n                                        \"pmid\": \"15015131\"\n                                    },\n                                    {\n                                        \"pubdate\": \"2015 Nov\",\n                                        \"title\": \"Whole-exome sequencing reveals diverse modes of inheritance in sporadic mild to moderate sensorineural hearing loss in a pediatric population.\",\n                                        \"source\": \"Genetics in medicine : official journal of the American College of Medical Genetics\",\n                                        \"author\": \"Kim NK\",\n                                        \"pmid\": \"25719458\"\n                                    }\n                                ]\n                            },\n                            \"PointsCounted\": 1.5,\n                            \"Count\": 2,\n                            \"TotalPoints\": 1.5\n                        },\n                        \"ProbandWithPredictedOrProvenNullVariant\": {\n                            \"Evidence\": {\n                                \"Publications\": [\n                                    {\n                                        \"pubdate\": \"2004 Apr\",\n                                        \"title\": \"Nonmuscle myosin heavy-chain gene MYH14 is expressed in cochlea and mutated in patients affected by autosomal dominant hearing impairment (DFNA4).\",\n                                        \"source\": \"American journal of human genetics\",\n                                        \"author\": \"Donaudy F\",\n                                        \"pmid\": \"15015131\"\n                                    },\n                                    {\n                                        \"pubdate\": \"2017 Apr\",\n                                        \"title\": \"Discovery of MYH14 as an important and unique deafness gene causing prelingually severe autosomal dominant nonsyndromic hearing loss.\",\n                                        \"source\": \"The journal of gene medicine\",\n                                        \"author\": \"Kim BJ\",\n                                        \"pmid\": \"28221712\"\n                                    }\n                                ]\n                            },\n                            \"PointsCounted\": 3,\n                            \"Count\": 2,\n                            \"TotalPoints\": 3\n                        }\n                    }\n                }\n            },\n            \"TotalGeneticEvidencePoints\": {\n                \"PointsCounted\": 8.55\n            },\n            \"CaseControlData\": {\n                \"PointsCounted\": 0,\n                \"SingleVariantAnalysis\": {\n                    \"Evidence\": {\n                        \"Publications\": [\n                            {\n                                \"pubdate\": \"2009 Mar\",\n                                \"title\": \"Candidate gene association study for noise-induced hearing loss in two independent noise-exposed populations.\",\n                                \"source\": \"Annals of human genetics\",\n                                \"author\": \"Konings A\",\n                                \"pmid\": \"19183343\"\n                            }\n                        ]\n                    },\n                    \"Count\": 4,\n                    \"TotalPoints\": 0\n                }\n            }\n        }\n    },\n    \"conditions\": [\n        {\n            \"name\": \"nonsyndromic genetic deafness\",\n            \"iri\": \"http://purl.obolibrary.org/obo/MONDO_0019497\",\n            \"uri\": \"MONDO0019497\",\n            \"curie\": \"MONDO:0019497\",\n            \"ontology\": \"MONDO\"\n        }\n    ],\n    \"jsonMessageVersion\": \"GCI.6\"\n}\n" ))


(deftest load-gene-validity-message-test
  (with-test-database
    (import-record! gene-validity-record)
    (is (= 1 (count (q/select "select ?x where { ?x a :sepio/GeneValidityReport }"))))))
