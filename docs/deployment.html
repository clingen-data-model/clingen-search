<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Enable k8s API</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Genegraph</span> <span class="project-version">0.0.1-SNAPSHOT</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="apis.html"><div class="inner"><span>APIs and code organization overview</span></div></a></li><li class="depth-1 "><a href="data_input.html"><div class="inner"><span>Data Input</span></div></a></li><li class="depth-1 "><a href="database.html"><div class="inner"><span>Database search and retrieval</span></div></a></li><li class="depth-1  current"><a href="deployment.html"><div class="inner"><span>Enable k8s API</span></div></a></li><li class="depth-1 "><a href="design.html"><div class="inner"><span>Design and Architecture</span></div></a></li><li class="depth-1 "><a href="genetic_condition.html"><div class="inner"><span>Genetic Condition</span></div></a></li><li class="depth-1 "><a href="graphql.html"><div class="inner"><span>GraphQL API</span></div></a></li><li class="depth-1 "><a href="reading_and_storing_data.html"><div class="inner"><span>Reading and Storing Data</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>genegraph</span></div></div></li><li class="depth-2 branch"><a href="genegraph.admin.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>admin</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>database</span></div></div></li><li class="depth-3 branch"><a href="genegraph.database.admin.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>admin</span></div></a></li><li class="depth-3 branch"><a href="genegraph.database.datafy.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datafy</span></div></a></li><li class="depth-3 branch"><a href="genegraph.database.instance.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>instance</span></div></a></li><li class="depth-3 branch"><a href="genegraph.database.load.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>load</span></div></a></li><li class="depth-3 branch"><a href="genegraph.database.names.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>names</span></div></a></li><li class="depth-3 branch"><a href="genegraph.database.query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>query</span></div></a></li><li class="depth-3"><a href="genegraph.database.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2 branch"><a href="genegraph.env.html"><div class="inner"><span class="tree" style="top: -238px;"><span class="top" style="height: 247px;"></span><span class="bottom"></span></span><span>env</span></div></a></li><li class="depth-2 branch"><a href="genegraph.migration.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>migration</span></div></a></li><li class="depth-2 branch"><a href="genegraph.server.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>server</span></div></a></li><li class="depth-2 branch"><a href="genegraph.service.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>service</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sink</span></div></div></li><li class="depth-3 branch"><a href="genegraph.sink.base.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>base</span></div></a></li><li class="depth-3 branch"><a href="genegraph.sink.fetch.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fetch</span></div></a></li><li class="depth-3 branch"><a href="genegraph.sink.stream.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>stream</span></div></a></li><li class="depth-3"><a href="genegraph.sink.validation.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>validation</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>source</span></div></div></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>graphql</span></div></div></li><li class="depth-4 branch"><a href="genegraph.source.graphql.actionability.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>actionability</span></div></a></li><li class="depth-4 branch"><a href="genegraph.source.graphql.class.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>class</span></div></a></li><li class="depth-4 branch"><a href="genegraph.source.graphql.concept.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>concept</span></div></a></li><li class="depth-4 branch"><a href="genegraph.source.graphql.condition.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>condition</span></div></a></li><li class="depth-4 branch"><a href="genegraph.source.graphql.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-4 branch"><a href="genegraph.source.graphql.evidence.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>evidence</span></div></a></li><li class="depth-4 branch"><a href="genegraph.source.graphql.gene.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>gene</span></div></a></li><li class="depth-4 branch"><a href="genegraph.source.graphql.gene-dosage.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>gene-dosage</span></div></a></li><li class="depth-4 branch"><a href="genegraph.source.graphql.property.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>property</span></div></a></li><li class="depth-4 branch"><a href="genegraph.source.graphql.resource.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>resource</span></div></a></li><li class="depth-4 branch"><a href="genegraph.source.graphql.server-status.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>server-status</span></div></a></li><li class="depth-4"><a href="genegraph.source.graphql.value-set.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>value-set</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree" style="top: -393px;"><span class="top" style="height: 402px;"></span><span class="bottom"></span></span><span>html</span></div></div></li><li class="depth-4 branch"><a href="genegraph.source.html.common.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>common</span></div></a></li><li class="depth-4"><a href="genegraph.source.html.elements.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>elements</span></div></a></li><li class="depth-5 branch"><a href="genegraph.source.html.elements.class.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>class</span></div></a></li><li class="depth-5 branch"><a href="genegraph.source.html.elements.dosage-sensitivity-proposition.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>dosage-sensitivity-proposition</span></div></a></li><li class="depth-5 branch"><a href="genegraph.source.html.elements.evidence-level-assertion.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>evidence-level-assertion</span></div></a></li><li class="depth-5 branch"><a href="genegraph.source.html.elements.functional-copy-number-complement.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>functional-copy-number-complement</span></div></a></li><li class="depth-5 branch"><a href="genegraph.source.html.elements.genes.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>genes</span></div></a></li><li class="depth-5 branch"><a href="genegraph.source.html.elements.genetic-dosage.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>genetic-dosage</span></div></a></li><li class="depth-5 branch"><a href="genegraph.source.html.elements.object-property.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>object-property</span></div></a></li><li class="depth-5 branch"><a href="genegraph.source.html.elements.study-finding.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>study-finding</span></div></a></li><li class="depth-5"><a href="genegraph.source.html.elements.value-set.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>value-set</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree" style="top: -362px;"><span class="top" style="height: 371px;"></span><span class="bottom"></span></span><span>json</span></div></div></li><li class="depth-4"><a href="genegraph.source.json.common.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>common</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -858px;"><span class="top" style="height: 867px;"></span><span class="bottom"></span></span><span>transform</span></div></div></li><li class="depth-3 branch"><a href="genegraph.transform.actionability.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>actionability</span></div></a></li><li class="depth-3 branch"><a href="genegraph.transform.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-3 branch"><a href="genegraph.transform.gene.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>gene</span></div></a></li><li class="depth-3"><a href="genegraph.transform.omim.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>omim</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><p>The ClinGen Data Service is intended to be deployed on Kubernetes, in the Geisinger/Broad Google Cloud environment. The following steps describe the process for setting up a running instance of this from scratch, assuming no Kubernetes related services are running. It may be possible to reuse existing resources, for example, a running Kubernetes cluster. This process will change when we transition to a GitOps based deployment strategy.</p>
<p>It is recommended to run through at least the first tutorial for using Google Kubernetes Engine, both to ensure your local machine is configured appropriately and also to get a feel for the steps.</p>
<p><a href="https://cloud.google.com/kubernetes-engine/docs/tutorials/hello-app">https://cloud.google.com/kubernetes-engine/docs/tutorials/hello-app</a></p>
<h1><a href="#enable-k8s-api" name="enable-k8s-api"></a>Enable k8s API</h1>
<p>The API necessary for configuring Kubernetes is not available by default, enable it if necessary by visiting the following page in the GCP Console:</p>
<p><a href="https://console.cloud.google.com/kubernetes/">https://console.cloud.google.com/kubernetes/</a></p>
<h1><a href="#configure-cluster-resources-" name="configure-cluster-resources-"></a>Configure cluster resources.</h1>
<p>ClinGen Search requires Kubernetes-configured nodes with Local SSD available. Only one disk is required, more may be needed if the size of the database expands in future. More detail is available here: <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/local-ssd">https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/local-ssd</a> . At minimum, a machine with 8GB RAM and 2 cores is recommended (n1-standard-2 is appropriate). If scaling is required, it is preferable to increase the number of cores and amount of RAM on a single node, rather than spin up additional nodes (although two nodes would be more appropriate for a production configuraton)</p>
<p>The following command configures an appropriate one-node cluster in the staging environment:</p>
<pre><code>gcloud container clusters create clingen-staging --num-nodes 1 --local-ssd-count 1 --machine-type=n1-standard-2
</code></pre>
<h1><a href="#configure-secret" name="configure-secret"></a>Configure secret</h1>
<p>The password for decrypting the client certificate needs to be configured on the cluster, but only once. Password omitted.</p>
<pre><code>kubectl create secret generic serveur-key-pass --from-literal password=&lt;password&gt;
</code></pre>
<h1><a href="#create-static-ip" name="create-static-ip"></a>Create static IP</h1>
<p>The data service should have a static IP. If one does not exist, create it.</p>
<pre><code>gcloud compute addresses create clingen-ds-stage-ip --region us-east1
</code></pre>
<p>The IP can be retrieved:</p>
<pre><code>gcloud compute addresses list
</code></pre>
<p>Be sure the service.yaml manifest for the file includes this as the loadBalancerIP value.</p>
<h1><a href="#create-container-image-and-deploy-to-container-registry" name="create-container-image-and-deploy-to-container-registry"></a>Create container image and deploy to container registry</h1>
<p>Docker and the GCP command line tools are required on the local machine in order to build the image. There are no other dependencies on the local machine (though Java 11 and Leiningen are useful for development). If you haven’t already configure docker to use your GCP credentials:</p>
<pre><code>gcloud auth configure-docker
</code></pre>
<p>To build and upload image in the staging environment (change project name and version tag as appropriate):</p>
<pre><code>docker build -t gcr.io/clingen-stage/clingen-ds:v1
docker push gcr.io/clingen-stage/clingen-ds:v1
</code></pre>
<p>Make sure the image name is updated in deploy/<environment>/deployment.yaml for the target environment.</environment></p>
<h1><a href="#deploy-manifest-files" name="deploy-manifest-files"></a>Deploy manifest files</h1>
<p>The deployment files are located in deploy/<environment> To deploy stage:</environment></p>
<pre><code>kubectl apply -f deploy/stage/
</code></pre></div></div></div></body></html>